<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Update Student - Student Management System</title>
</head>
<body>
<header>
    <h1>Update Student Information</h1>
    <nav>
        <a href="/students">Back to Students</a> |
        <a href="/groups">Groups</a>
    </nav>
</header>

<main>
    <section>
        <h2>Edit Student Information</h2>
        <form id="updateStudentForm">
            <input type="hidden" id="studentId" name="studentId">

            <div>
                <label for="currentPhoto">Current Photo:</label>
                <img id="currentPhoto" src="/api/placeholder/150/150" alt="Current Student Photo" width="150">
            </div>

            <div>
                <label for="studentName">First Name:</label>
                <input type="text" id="studentName" name="studentName" required>
            </div>

            <div>
                <label for="studentSurname">Last Name:</label>
                <input type="text" id="studentSurname" name="studentSurname" required>
            </div>

            <div>
                <label for="studentPhoto">New Photo (optional):</label>
                <input type="file" id="studentPhoto" name="studentPhoto" accept="image/png, image/jpeg, image/jpg">
            </div>

            <div>
                <label for="studentGroup">Group:</label>
                <select id="studentGroup" name="studentGroup" required>
                    <option value="">Select Group</option>
                </select>
            </div>

            <div>
                <button type="submit">Update Student</button>
                <button type="button" onclick="window.location.href='/students'">Cancel</button>
            </div>
        </form>
    </section>
</main>
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const studentId = urlParams.get('id');

    async function loadStudentData() {
    try {
        const response = await fetch(`${window.API_BASE_URL}/api/students/${studentId}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const student = await response.json();

        document.getElementById('studentId').value = student.id;
        document.getElementById('studentName').value = student.name;
        document.getElementById('studentSurname').value = student.surname;
        document.getElementById('currentPhoto').src = `${window.API_BASE_URL}/api/students/image/${student.id}`;
        document.getElementById('currentPhoto').onerror = function() {
            this.src = '/static/img/placeholder.png';
        };
        document.getElementById('studentGroup').value = student.group_id;
    } catch (error) {
        console.error('Error loading student data:', error);
        alert('Failed to load student data');
    }
}

    async function loadGroups() {
        try {
            const response = await fetch(`${window.API_BASE_URL}/api/groups`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const groups = await response.json();
            
            const formSelect = document.getElementById('studentGroup');
            formSelect.innerHTML = '<option value="">Select Group</option>';
            groups.forEach(group => {
                formSelect.innerHTML += `<option value="${group.id}">${group.name}</option>`;
            });
        } catch (error) {
            console.error('Error loading groups:', error);
        }
    }

    async function handleUpdateStudent(event) {
        event.preventDefault();
        const formData = new FormData(event.target);

        try {
            const response = await fetch(`${window.API_BASE_URL}/api/students/${studentId}`, {
                method: 'PUT',
                body: formData
            });

            if (response.ok) {
                alert('Student updated successfully');
                window.location.href = '/students';
            } else {
                const errorText = await response.text();
                throw new Error(errorText || 'Failed to update student');
            }
        } catch (error) {
            console.error('Error updating student:', error);
            alert(error.message || 'Failed to update student');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        if (!studentId) {
            alert('No student ID provided');
            window.location.href = '/students';
            return;
        }
        loadGroups().then(() => loadStudentData());

        document.getElementById('updateStudentForm').addEventListener('submit', handleUpdateStudent);
        
        document.getElementById('studentPhoto').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                if (!file.type.match('image/jpeg') && !file.type.match('image/png')) {
                    alert('Please select a JPEG or PNG image.');
                    event.target.value = '';
                }
            }
        });
    });
</script>
</body>
</html>