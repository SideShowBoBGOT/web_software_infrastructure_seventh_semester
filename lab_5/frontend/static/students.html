<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Students - Student Management System</title>
</head>
<body>
<header>
    <h1>Student Management System</h1>
    <nav>
        <a href="/students">Students</a> |
        <a href="/groups">Groups</a>
    </nav>
</header>

<main>
    <section>
        <h2>Add New Student</h2>
        <form id="addStudentForm">
            <div>
                <label for="studentName">First Name:</label>
                <input type="text" id="studentName" name="studentName" required>
            </div>
            <div>
                <label for="studentSurname">Last Name:</label>
                <input type="text" id="studentSurname" name="studentSurname" required>
            </div>
            <div>
                <label for="studentPhoto">Photo:</label>
                <input type="file" id="studentPhoto" name="studentPhoto" accept="image/png, image/jpeg, image/jpg" required>
            </div>
            <div>
                <label for="studentGroup">Group:</label>
                <select id="studentGroup" name="studentGroup" required>
                    <option value="">Select Group</option>
                </select>
            </div>
            <div>
                <button type="submit">Add Student</button>
            </div>
        </form>
    </section>

    <section>
        <h2>Student List</h2>
        <div>
            <label for="filterGroup">Filter by Group:</label>
            <select id="filterGroup" name="filterGroup">
                <option value="">All Groups</option>
            </select>
        </div>

        <table>
            <thead>
            <tr>
                <th>ID</th>
                <th>Photo</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Group</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody id="studentsTable">
            <!-- Example row -->
                <tr>
                    <td>1</td>
                    <td><img src="/static/img/placeholder.png" alt="Student Photo" width="160" height="120"></td>
                    <td>John</td>
                    <td>Doe</td>
                    <td>Group A</td>
                    <td>
                        <a href="/update-student?id=1">Edit</a>
                        <button onclick="deleteStudent(1)">Delete</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </section>
</main>
<script>
    async function loadStudents() {
        try {
            const response = await fetch(`${window.API_BASE_URL}/api/students`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const text = await response.text();
            console.log('Raw response:', text);
            
            const students = JSON.parse(text);
            console.log('Parsed students:', students);
            
            const table = document.getElementById('studentsTable');
            table.innerHTML = '';
            
            students.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.id}</td>
                    <td>
                        <img src="${window.API_BASE_URL}/api/students/image/${student.id}" 
                            alt="Student Photo" 
                            width="160"
                            height="120"
                            onerror="this.src='/static/img/placeholder.png'">
                    </td>
                    <td>${student.name}</td>
                    <td>${student.surname}</td>
                    <td>${student.group_id}</td>
                    <td>
                        <a href="/update-student?id=${student.id}">Edit</a>
                        <button onclick="deleteStudent(${student.id})">Delete</button>
                    </td>
                `;
                table.appendChild(row);
            });
        } catch (error) {
            console.error('Error loading students:', error);
        }
    }

    async function handleAddStudent(event) {
        event.preventDefault();
        const formData = new FormData(event.target);

        try {
            const response = await fetch('/api/students', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                alert('Student added successfully');
                event.target.reset();
                loadStudents();
            } else {
                throw new Error('Failed to add student');
            }
        } catch (error) {
            console.error('Error adding student:', error);
            alert('Failed to add student');
        }
    }

    async function deleteStudent(id) {
        if (confirm('Are you sure you want to delete this student?')) {
            try {
                const response = await fetch(`${window.API_BASE_URL}/api/students/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Student deleted successfully');
                    loadStudents();
                } else {
                    throw new Error('Failed to delete student');
                }
            } catch (error) {
                console.error('Error deleting student:', error);
                alert('Failed to delete student');
            }
        }
    }

    // Filter students by group
    document.getElementById('filterGroup').addEventListener('change', async function(event) {
        const groupId = event.target.value;
        try {
            const url = groupId ? `${window.API_BASE_URL}/api/students?group=${groupId}` : `${window.API_BASE_URL}/api/students`;
            const response = await fetch(url);
            const students = await response.json();
            // Update table with filtered students
            // Implementation here
        } catch (error) {
            console.error('Error filtering students:', error);
        }
    });

    // Load initial data when page loads
    document.addEventListener('DOMContentLoaded', () => {
        loadStudents();

        // Add form submit event listener
        document.getElementById('addStudentForm').addEventListener('submit', handleAddStudent);
    });
</script>
</body>
</html>